<!DOCTYPE html>
<html lang="zh-TW">
<%- include('partials/header') %>
<body class="bg-gray-900 text-white font-sans">
    <nav class="p-6 flex justify-between items-center bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold tracking-widest">後台管理系統</h1>
            <span class="px-3 py-1 bg-blue-500/20 text-blue-300 text-xs rounded-full border border-blue-500/30">
                Admin: <%= user %>
            </span>
        </div>

        <div class="flex gap-4">
            <a href="/home" target="_blank" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded text-sm font-bold transition flex items-center gap-2">
                <span class="material-symbols-rounded text-sm">home</span>
                回前台首頁
            </a>
            
            <a href="/logout" class="bg-red-500/80 hover:bg-red-600 px-4 py-2 rounded text-sm font-bold transition">
                登出
            </a>
        </div>
    </nav>

    <main class="p-10 container mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h2 class="text-3xl font-light mb-2">店家資料庫</h2>
                <p class="text-white/40 text-sm">直接點擊文字編輯，分類可多選 (捲動選擇)，修改後點擊「儲存」。</p>
            </div>
            <button onclick="openAddModal()" 
                    class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold tracking-wider shadow-lg shadow-emerald-500/20 transition-all flex items-center gap-2">
                <span class="material-symbols-rounded">add_location</span> 新增店家
            </button>
        </header>

        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
                <span class="material-symbols-rounded absolute left-4 top-1/2 -translate-y-1/2 text-white/30">search</span>
                <input type="text" id="admin-search-input" onkeyup="filterAdminTable()" 
                    placeholder="輸入店名或地址快速搜尋..." 
                    class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white focus:border-blue-500 outline-none transition-colors">
            </div>
            
            <div class="relative min-w-[200px]">
                <span class="material-symbols-rounded absolute left-4 top-1/2 -translate-y-1/2 text-white/30">filter_alt</span>
                <select id="admin-category-filter" onchange="filterAdminTable()"
                    class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-12 pr-10 text-white focus:border-blue-500 outline-none appearance-none cursor-pointer">
                    <option value="all" class="text-black bg-white">所有分類</option>
                    <% styles.forEach(s => { %>
                        <option value="<%= s.style_id %>" class="text-black bg-white"><%= s.style_name %></option>
                    <% }) %>
                </select>
                <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none opacity-50">
                    <span class="material-symbols-rounded">expand_more</span>
                </div>
            </div>
        </div>
        
        <div class="glass p-1 rounded-2xl border border-white/10 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-white/5 border-b border-white/10 text-xs uppercase tracking-widest text-white/50">
                            <th class="p-4 w-16">ID</th>
                            <th class="p-4 w-48">店名</th>
                            <th class="p-4 w-20">評分</th>
                            <th class="p-4 w-48">分類 (多選)</th>
                            <th class="p-4 w-64">地址</th>
                            <th class="p-4 w-24">緯度</th>
                            <th class="p-4 w-24">經度</th>
                            <th class="p-4 w-32">操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5" id="admin-table-body">
                        <% stores.forEach(shop => { 
                            // ★ 關鍵：將這家店擁有的所有 Style ID 串接成字串，方便 JS 搜尋
                            const shopStyleIds = shop.Styles ? shop.Styles.map(s => s.style_id).join(',') : '';
                        %>
                        <tr class="store-row hover:bg-white/5 transition group" 
                            data-name="<%= shop.Name.toLowerCase() %> <%= shop.address.toLowerCase() %>" 
                            data-styles="<%= shopStyleIds %>">
                            
                            <td class="p-4 font-mono opacity-50"><%= shop.store_id %></td>
                            <td class="p-4 outline-none focus:bg-white/10 rounded" contenteditable="true" id="name-<%= shop.store_id %>"><%= shop.Name %></td>
                            <td class="p-4 outline-none focus:bg-white/10 rounded" contenteditable="true" id="rating-<%= shop.store_id %>"><%= shop.rating %></td>

                            <td class="p-4">
                                <div id="styles-container-<%= shop.store_id %>" class="h-24 overflow-y-auto custom-scrollbar bg-black/30 border border-white/10 rounded p-2 space-y-1">
                                    <% styles.forEach(s => { 
                                        const isChecked = shop.Styles && shop.Styles.some(shopStyle => shopStyle.style_id === s.style_id);
                                    %>
                                        <label class="flex items-center gap-2 cursor-pointer hover:bg-white/5 p-1 rounded">
                                            <input type="checkbox" 
                                                   value="<%= s.style_id %>" 
                                                   class="style-checkbox-<%= shop.store_id %> accent-blue-500"
                                                   <%= isChecked ? 'checked' : '' %>>
                                            <span class="text-xs text-white/80"><%= s.style_name %></span>
                                        </label>
                                    <% }) %>
                                </div>
                            </td>

                            <td class="p-4 outline-none focus:bg-white/10 rounded text-sm opacity-80" contenteditable="true" id="address-<%= shop.store_id %>"><%= shop.address %></td>
                            <td class="p-4 outline-none focus:bg-white/10 rounded font-mono text-xs text-blue-300" contenteditable="true" id="lat-<%= shop.store_id %>"><%= shop.latitude %></td>
                            <td class="p-4 outline-none focus:bg-white/10 rounded font-mono text-xs text-blue-300" contenteditable="true" id="lng-<%= shop.store_id %>"><%= shop.longitude %></td>
                            
                            <td class="p-4 flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="updateShop('<%= shop.store_id %>')" class="bg-blue-600/80 hover:bg-blue-500 px-3 py-1 rounded text-xs font-bold transition">儲存</button>
                                <button onclick="deleteShop('<%= shop.store_id %>')" class="bg-red-600/80 hover:bg-red-500 px-3 py-1 rounded text-xs font-bold transition">刪除</button>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
                <div id="no-result-msg" class="hidden text-center py-12 text-white/30 text-sm tracking-widest">
                    沒有符合條件的店家
                </div>
            </div>
        </div>
    </main>

    <div id="add-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-[100] opacity-0 transition-opacity duration-300">
        <div class="bg-zinc-900 border border-white/10 p-8 rounded-3xl w-full max-w-lg shadow-2xl transform scale-95 transition-transform duration-300" id="add-modal-content">
            <h3 class="text-2xl font-bold mb-6 text-white">新增美食店家</h3>
            
            <div class="space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase tracking-wider text-white/50 mb-1">店名 *</label>
                        <input type="text" id="new-name" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-emerald-500 outline-none" placeholder="店家名稱">
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wider text-white/50 mb-1">評分</label>
                        <input type="number" step="0.1" id="new-rating" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-emerald-500 outline-none" value="4.0">
                    </div>
                </div>

                <div>
                    <label class="block text-xs uppercase tracking-wider text-white/50 mb-1">分類 (可多選)</label>
                    <div class="w-full bg-white/5 border border-white/10 rounded-lg p-3 grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                        <% styles.forEach(s => { %>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-white/5 p-1 rounded">
                                <input type="checkbox" name="new-style-checkbox" value="<%= s.style_id %>" class="accent-emerald-500">
                                <span class="text-sm text-white"><%= s.style_name %></span>
                            </label>
                        <% }) %>
                    </div>
                </div>

                <div>
                    <label class="block text-xs uppercase tracking-wider text-white/50 mb-1">地址</label>
                    <input type="text" id="new-address" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-emerald-500 outline-none" placeholder="完整地址">
                </div>

                <div class="grid grid-cols-2 gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <div class="col-span-2 text-xs text-emerald-400 mb-1 flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">map</span> 地圖座標設定
                        <a href="https://www.google.com/maps" target="_blank" class="underline opacity-50 hover:opacity-100 ml-auto">去 Google Maps 找座標 ↗</a>
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wider text-white/50 mb-1">緯度 (Lat)</label>
                        <input type="number" step="0.000001" id="new-lat" class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white font-mono focus:border-emerald-500 outline-none" placeholder="24.99...">
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-wider text-white/50 mb-1">經度 (Lng)</label>
                        <input type="number" step="0.000001" id="new-lng" class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white font-mono focus:border-emerald-500 outline-none" placeholder="121.45...">
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeAddModal()" class="flex-1 py-3 rounded-xl border border-white/10 hover:bg-white/5 transition text-white/60 hover:text-white">取消</button>
                <button onclick="createShop()" class="flex-1 py-3 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold shadow-lg shadow-emerald-500/20 transition">確認新增</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('add-modal-content');

        function openAddModal() {
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }

        function closeAddModal() {
            modal.classList.add('opacity-0'); modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95');
            setTimeout(() => { 
                modal.classList.add('hidden');
                // 重置所有輸入框與checkbox
                document.getElementById('new-name').value = '';
                document.getElementById('new-rating').value = '4.0';
                document.getElementById('new-address').value = '';
                document.getElementById('new-lat').value = '';
                document.getElementById('new-lng').value = '';
                document.querySelectorAll('input[name="new-style-checkbox"]').forEach(cb => cb.checked = false);
            }, 300);
        }
        // === 搜尋與篩選功能 ===
        function filterAdminTable() {
            // 1. 取得搜尋關鍵字 (轉小寫)
            const searchText = document.getElementById('admin-search-input').value.toLowerCase();
            
            // 2. 取得選擇的分類 ID
            const selectedCat = document.getElementById('admin-category-filter').value;
            
            // 3. 取得所有表格列
            const rows = document.querySelectorAll('.store-row');
            let visibleCount = 0;

            rows.forEach(row => {
                // 從 data 屬性取得店名與分類資料
                const nameData = row.dataset.name; // 包含店名與地址
                const styleIds = row.dataset.styles.split(','); // 例如 "1,3,5"
                
                // 判斷是否符合搜尋文字
                const matchText = nameData.includes(searchText);
                
                // 判斷是否符合分類 (如果是 'all' 則略過檢查)
                const matchCat = selectedCat === 'all' || styleIds.includes(selectedCat);

                // 同時符合才顯示
                if (matchText && matchCat) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });

            // 控制「查無資料」的顯示
            const noResult = document.getElementById('no-result-msg');
            if (visibleCount === 0) {
                noResult.classList.remove('hidden');
            } else {
                noResult.classList.add('hidden');
            }
        }
        // === API 功能 (支援多選) ===

        // 1. 新增店家
        async function createShop() {
            const name = document.getElementById('new-name').value;
            const rating = document.getElementById('new-rating').value;
            const address = document.getElementById('new-address').value;
            const lat = document.getElementById('new-lat').value;
            const lng = document.getElementById('new-lng').value;
            
            // ★ 收集多選 Checkbox 的值
            const checkboxes = document.querySelectorAll('input[name="new-style-checkbox"]:checked');
            const styleIds = Array.from(checkboxes).map(cb => cb.value);

            if (!name) return alert('請輸入店名！');

            try {
                const res = await fetch('/admin/create-shop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, rating, address, lat, lng, styleIds })
                });

                const data = await res.json();
                if (data.success) {
                    alert('新增成功！');
                    location.reload();
                } else {
                    alert('新增失敗：' + data.message);
                }
            } catch (error) {
                console.error(error);
                alert('系統錯誤');
            }
        }

        // 2. 更新店家
        async function updateShop(id) {
            const name = document.getElementById(`name-${id}`).innerText.trim();
            const rating = document.getElementById(`rating-${id}`).innerText.trim();
            const address = document.getElementById(`address-${id}`).innerText.trim();
            const lat = document.getElementById(`lat-${id}`).innerText.trim();
            const lng = document.getElementById(`lng-${id}`).innerText.trim();
            
            // ★ 收集該店家 Checkbox 的值
            const checkboxes = document.querySelectorAll(`.style-checkbox-${id}:checked`);
            const styleIds = Array.from(checkboxes).map(cb => cb.value);

            try {
                const res = await fetch('/admin/update-shop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, name, rating, address, lat, lng, styleIds })
                });
                const data = await res.json();
                if(data.success) alert('更新成功！資料已同步。');
                else alert('更新失敗');
            } catch (error) {
                console.error(error);
                alert('系統錯誤');
            }
        }

        // 3. 刪除店家
        async function deleteShop(id) {
            if(!confirm('⚠️ 確定要刪除這筆資料嗎？此動作無法復原。')) return;
            try {
                const res = await fetch('/admin/delete-shop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if(data.success) location.reload();
                else alert('刪除失敗');
            } catch (error) {
                alert('系統錯誤');
            }
        }
    </script>
</body>
</html>