<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾é£Ÿåœ°åœ– - RNG</title>
    
    <!-- ä½¿ç”¨å¿«é€ŸCDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <!-- é å…ˆè¼‰å…¥é—œéµè³‡æº -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    
    <style>
        /* ========================================
           å…¨å±€é»‘ç™½ç°¡ç´„é¢¨æ ¼è¨­å®š
           ======================================== */
        :root {
            --black: #000000;
            --white: #ffffff;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
            --surface: rgba(255, 255, 255, 0.08); /* è¡¨é¢å±¤èƒŒæ™¯ */
            --border-light: rgba(255, 255, 255, 0.15); /* æ·ºé‚Šæ¡† */
        }
        
        /* åŸºç¤è¨­å®š */
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--black);
            color: var(--white);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }
        
        /* ========================================
           è¼•é‡ç´šåŠ è¼‰ç•«é¢
           ======================================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--black);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        /* æ¥µç°¡åŠ è¼‰å‹•ç•« */
        .loading-animation {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }
        
        .loading-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--white);
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        .loading-dot:nth-child(1) {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            animation-delay: 0s;
        }
        
        .loading-dot:nth-child(2) {
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            animation-delay: 0.15s;
        }
        
        .loading-dot:nth-child(3) {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            animation-delay: 0.3s;
        }
        
        .loading-dot:nth-child(4) {
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            animation-delay: 0.45s;
        }
        
        @keyframes dotPulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        .loading-text {
            font-size: 1.2rem;
            font-weight: 300;
            color: var(--white);
            letter-spacing: 1px;
            margin-top: 15px;
        }
        
        .loading-subtext {
            font-size: 0.85rem;
            font-weight: 300;
            color: var(--gray-400);
            margin-top: 10px;
            text-align: center;
            max-width: 200px;
            line-height: 1.4;
        }
        
        /* é€²åº¦æ¢ */
        .loading-progress {
            width: 150px;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            border-radius: 1px;
        }
        
        .loading-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 30%;
            background-color: var(--white);
            animation: progressMove 1.5s ease-in-out infinite;
        }
        
        @keyframes progressMove {
            0% {
                left: -30%;
            }
            100% {
                left: 100%;
            }
        }
        
        /* ========================================
           é»‘ç™½æ¯›ç»ç’ƒå°è¦½åˆ—
           ======================================== */
        .navbar {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 60px;
            
            /* é»‘ç™½æ¯›ç»ç’ƒæ•ˆæœ */
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 0 20px; 
            box-sizing: border-box; 
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .navbar.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .nav-logo {
            font-size: 1.5rem; 
            font-weight: 300;
            color: var(--white);
            text-decoration: none;
            letter-spacing: 1px;
        }
        
        .nav-btn {
            text-decoration: none; 
            color: var(--white); 
            font-size: 0.85rem;
            font-weight: 400; 
            padding: 6px 12px;
            border-radius: 6px; 
            transition: all 0.2s ease;
            display: flex; 
            align-items: center; 
            gap: 5px;
            border: 1px solid transparent;
        }
        
        .nav-btn:hover { 
            background-color: rgba(255, 255, 255, 0.08);
        }
        
        .nav-side { 
            display: flex; 
            gap: 5px; 
            flex: 1; 
            align-items: center; 
        }
        
        .nav-right { 
            justify-content: flex-end; 
        }
        
        /* ========================================
           åœ°åœ–å®¹å™¨èˆ‡æ¨£å¼
           ======================================== */
        #map {
            width: 100%;
            /* æ‰£æ‰å°è¦½åˆ—é«˜åº¦ (60px) */
            height: calc(100vh - 60px);
            margin-top: 60px;
            z-index: 1;
            background-color: var(--black);
        }
        
        /* èª¿æ•´Leafletåœ°åœ–æ§ä»¶çš„é»‘ç™½é¢¨æ ¼ */
        .leaflet-control-container .leaflet-control {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--white);
        }
        
        .leaflet-control-zoom a {
            background-color: rgba(0, 0, 0, 0.8);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .leaflet-control-zoom a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .leaflet-control-attribution {
            background-color: rgba(0, 0, 0, 0.7) !important;
            color: var(--gray-400) !important;
            font-size: 0.7rem;
            padding: 2px 5px !important;
        }
        
        /* è‡ªè¨‚å½ˆå‡ºè¦–çª—æ¨£å¼ */
        .leaflet-popup-content-wrapper {
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--white);
            border-radius: 10px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 300px;
        }
        
        .leaflet-popup-content {
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            width: auto !important;
        }
        
        .leaflet-popup-tip-container {
            margin-top: -1px;
        }
        
        .leaflet-popup-tip {
            background-color: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* ========================================
           å®šä½æŒ‰éˆ•
           ======================================== */
        .locate-btn {
            position: absolute; 
            bottom: 20px; 
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px; 
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer; 
            z-index: 999;
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .locate-btn.visible {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.2s;
        }
        
        .locate-btn:hover { 
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        
        .locate-btn:active { 
            transform: scale(0.95); 
        }
        
        .locate-btn span { 
            color: var(--white); 
            font-size: 1.3rem; 
        }
        
        /* ========================================
           ç¾é£Ÿé¤å»³éæ¿¾å™¨
           ======================================== */
        .filter-container {
            position: absolute;
            top: 80px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            z-index: 998;
            width: 180px;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s ease;
        }
        
        .filter-container.visible {
            opacity: 1;
            transform: translateX(0);
            transition-delay: 0.3s;
        }
        
        .filter-title {
            font-size: 1rem;
            font-weight: 400;
            color: var(--white);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-title span {
            font-size: 1.2rem;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--gray-300);
            margin-bottom: 8px;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
        }
        
        .filter-checkbox input {
            margin-right: 8px;
            accent-color: var(--white);
        }
        
        .filter-checkbox span {
            font-size: 0.9rem;
            color: var(--gray-300);
            transition: color 0.2s ease;
        }
        
        .filter-checkbox:hover span {
            color: var(--white);
        }
        
        /* ========================================
           ç‹€æ…‹æ–‡å­—æ¨£å¼
           ======================================== */
        #status-text {
            font-weight: 300;
            color: var(--gray-300);
            font-size: 0.85rem;
        }
        
        /* ========================================
           ç¾é£Ÿé¤å»³æ¨™è¨˜æ¨£å¼ - å¤§é»è¨­è¨ˆ
           ======================================== */
        /* é¤å»³æ¨™è¨˜æ¨£å¼ - å¤§é»è¨­è¨ˆ */
        .restaurant-marker {
            background-color: var(--white);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid var(--black);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4), 0 0 0 2px rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* æ‡¸åœæ•ˆæœ */
        .restaurant-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6), 0 0 0 3px rgba(255, 255, 255, 0.2);
            z-index: 1000 !important;
        }
        
        /* ä¸åŒé¡å‹çš„é¤å»³æ¨™è¨˜ */
        .restaurant-marker.noodle {
            background-color: var(--white);
        }
        
        .restaurant-marker.noodle::after {
            content: 'ğŸœ';
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .restaurant-marker.rice {
            background-color: var(--white);
        }
        
        .restaurant-marker.rice::after {
            content: 'ğŸš';
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .restaurant-marker.western {
            background-color: var(--white);
        }
        
        .restaurant-marker.western::after {
            content: 'ğŸ';
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .restaurant-marker.light {
            background-color: var(--white);
        }
        
        .restaurant-marker.light::after {
            content: 'ğŸ¥—';
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* é«˜äº®é¸ä¸­çš„æ¨™è¨˜ */
        .restaurant-marker.highlighted {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 0 3px rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 0 3px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 25px rgba(255, 255, 255, 1), 0 0 0 4px rgba(255, 255, 255, 0.5);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 0 3px rgba(255, 255, 255, 0.3);
            }
        }
        
        /* ç”¨æˆ¶ä½ç½®æ¨™è¨˜æ¨£å¼ */
        .user-marker {
            background-color: var(--white);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid var(--black);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-marker::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--black);
            border-radius: 50%;
        }
        
        /* ========================================
           å½ˆå‡ºè¦–çª—å…§å®¹æ¨£å¼
           ======================================== */
        .restaurant-popup {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            width: 280px;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .restaurant-name {
            font-size: 1.3rem;
            font-weight: 400;
            color: var(--white);
            margin: 0;
            line-height: 1.3;
        }
        
        .restaurant-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .rating-stars {
            color: var(--white);
            font-size: 1rem;
            letter-spacing: 2px;
        }
        
        .rating-value {
            font-size: 0.9rem;
            color: var(--gray-400);
        }
        
        .restaurant-description {
            font-size: 0.95rem;
            color: var(--gray-300);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .restaurant-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-item span {
            font-size: 1rem;
            color: var(--white);
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: var(--gray-400);
        }
        
        .restaurant-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* ========================================
           éŸ¿æ‡‰å¼è¨­è¨ˆ
           ======================================== */
        @media (max-width: 768px) {
            .navbar {
                height: 55px;
                padding: 0 15px;
            }
            
            .nav-logo {
                font-size: 1.3rem;
            }
            
            .nav-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            #map {
                height: calc(100vh - 55px);
                margin-top: 55px;
            }
            
            .locate-btn {
                bottom: 15px;
                right: 15px;
                padding: 10px;
            }
            
            .locate-btn span {
                font-size: 1.2rem;
            }
            
            .filter-container {
                top: 70px;
                left: 15px;
                width: 160px;
                padding: 12px;
            }
            
            .restaurant-marker {
                width: 32px;
                height: 32px;
            }
            
            .restaurant-marker.noodle::after,
            .restaurant-marker.rice::after,
            .restaurant-marker.western::after,
            .restaurant-marker.light::after {
                font-size: 14px;
            }
            
            .loading-animation {
                width: 60px;
                height: 60px;
            }
            
            .loading-dot {
                width: 10px;
                height: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .nav-btn span:not(.material-symbols-rounded) {
                display: none;
            }
            
            .nav-btn {
                padding: 6px;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                justify-content: center;
            }
            
            .nav-logo {
                font-size: 1.1rem;
            }
            
            #status-text {
                display: none;
            }
            
            .filter-container {
                width: 140px;
                padding: 10px;
            }
            
            .filter-title {
                font-size: 0.9rem;
            }
            
            .filter-checkbox span {
                font-size: 0.85rem;
            }
            
            .restaurant-popup {
                width: 250px;
            }
            
            .loading-text {
                font-size: 1rem;
            }
            
            .loading-subtext {
                font-size: 0.8rem;
                max-width: 180px;
            }
        }
    </style>
</head>
<body>
    <!-- è¼•é‡ç´šåŠ è¼‰ç•«é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-animation">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <div class="loading-text">ç¾é£Ÿåœ°åœ–</div>
        <div class="loading-subtext" id="loadingMessage">è¼‰å…¥ç¾é£Ÿé¤å»³è³‡æ–™...</div>
        <div class="loading-progress"></div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="navbar" id="navbar">
        <div class="nav-side nav-left">
            <a href="./13.html" class="nav-btn">
                <span class="material-symbols-rounded">arrow_back</span>
                <span>è¿”å›é¦–é </span>
            </a>
        </div>
        
        <a href="#" class="nav-logo">ç¾é£Ÿåœ°åœ–</a>
        
        <div class="nav-side nav-right">
            <div class="nav-btn" style="cursor: default;">
                <span class="material-symbols-rounded">restaurant</span>
                <span id="status-text">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
    </nav>

    <!-- ç¾é£Ÿé¤å»³éæ¿¾å™¨ -->
    <div class="filter-container" id="filterContainer">
        <div class="filter-title">
            <span class="material-symbols-rounded">filter_alt</span>
            ç¯©é¸é¤å»³
        </div>
        <div class="filter-group">
            <label>é¤å»³é¡å‹</label>
            <div class="filter-checkbox">
                <input type="checkbox" id="filter-noodle" checked>
                <span>éºµé£Ÿ</span>
            </div>
            <div class="filter-checkbox">
                <input type="checkbox" id="filter-rice" checked>
                <span>ç±³é£¯</span>
            </div>
            <div class="filter-checkbox">
                <input type="checkbox" id="filter-western" checked>
                <span>è¥¿å¼</span>
            </div>
            <div class="filter-checkbox">
                <input type="checkbox" id="filter-light" checked>
                <span>è¼•é£Ÿ</span>
            </div>
        </div>
        <div class="filter-group">
            <label>è©•åˆ†ç¯©é¸</label>
            <div class="filter-checkbox">
                <input type="checkbox" id="filter-rating-4" checked>
                <span>4æ˜Ÿä»¥ä¸Š</span>
            </div>
        </div>
    </div>

    <!-- åœ°åœ–å®¹å™¨ -->
    <div id="map"></div>

    <!-- å®šä½æŒ‰éˆ• -->
    <div class="locate-btn" id="locateBtn" onclick="locateUser()" title="å›åˆ°æˆ‘çš„ä½ç½®">
        <span class="material-symbols-rounded">near_me</span>
    </div>

    <!-- ç•°æ­¥è¼‰å…¥ Leaflet JS -->
    <script>
        // ç¾é£Ÿé¤å»³è³‡æ–™
        const restaurants = [
            {
                name: "è€ç‹ç‰›è‚‰éºµ",
                lat: 25.0488,
                lng: 121.5180,
                description: "å‚³æ‰¿ä¸‰ä»£çš„è€å­—è™Ÿç‰›è‚‰éºµåº—ï¼Œæ¹¯é ­æ¿ƒéƒï¼Œä½¿ç”¨æ¾³æ´²é€²å£ç‰›è‚‰",
                rating: 4.5,
                category: "noodle",
                price: "NT$ 150",
                hours: "11:00-21:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€åŒ—å¹³è¥¿è·¯1è™Ÿ",
                phone: "02-2311-2233",
                features: ["å…è²»åŠ æ¹¯", "å¯å¤–å¸¶", "æœ‰å†·æ°£"]
            },
            {
                name: "å··å£ç‚¸é›",
                lat: 25.0465,
                lng: 121.5160,
                description: "å¤–é…¥å…§å«©çš„ç¾ç‚¸ç‚¸é›ï¼Œä½¿ç”¨ç‰¹è£½é¦™æ–™é†ƒè£½",
                rating: 4.2,
                category: "western",
                price: "NT$ 80-150",
                hours: "14:00-23:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€æ¼¢å£è¡—ä¸€æ®µ5è™Ÿ",
                phone: "02-2388-5566",
                features: ["ç¾ç‚¸ç¾è³£", "å¤–å¸¶å°ˆè³£", "å¤šç¨®å£å‘³"]
            },
            {
                name: "æ–‡é’å’–å•¡é¤¨",
                lat: 25.0470,
                lng: 121.5190,
                description: "å……æ»¿æ–‡è—æ°£æ¯çš„å’–å•¡é¤¨ï¼Œæä¾›æ‰‹æ²–å’–å•¡å’Œè¼•é£Ÿ",
                rating: 4.7,
                category: "light",
                price: "NT$ 120-250",
                hours: "08:00-22:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€å¿ å­è¥¿è·¯ä¸€æ®µ39è™Ÿ",
                phone: "02-2311-8899",
                features: ["å…è²»WiFi", "æ’åº§", "å¯µç‰©å‹å–„"]
            },
            {
                name: "æ—¥å¼æ‹‰éºµ",
                lat: 25.0490,
                lng: 121.5155,
                description: "æ­£å®—æ—¥æœ¬ä¹å·é¢¨å‘³æ‹‰éºµï¼Œæ¹¯é ­ç†¬ç…®12å°æ™‚",
                rating: 4.4,
                category: "noodle",
                price: "NT$ 220-280",
                hours: "11:30-21:30",
                address: "å°åŒ—å¸‚ä¸­æ­£å€é¤¨å‰è·¯8è™Ÿ",
                phone: "02-2312-3344",
                features: ["å…è²»åŠ éºµ", "æ—¥å¼é¢¨æ ¼", "å§å°åº§ä½"]
            },
            {
                name: "ç´ é£Ÿé¤å»³",
                lat: 25.0455,
                lng: 121.5175,
                description: "å¥åº·ç¾å‘³çš„ç´ é£Ÿæ–™ç†ï¼Œæä¾›å¤šæ¨£åŒ–çš„è”¬é£Ÿé¸æ“‡",
                rating: 4.3,
                category: "light",
                price: "NT$ 100-180",
                hours: "10:00-20:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€è¡¡é™½è·¯12è™Ÿ",
                phone: "02-2381-2233",
                features: ["å…¨ç´ å¯é¸", "å¥åº·å–å‘", "ç’°å¢ƒèˆ’é©"]
            },
            {
                name: "æ¸¯å¼ç‡’è‡˜",
                lat: 25.0500,
                lng: 121.5200,
                description: "æ­£å®—é¦™æ¸¯å¸«å‚…è£½ä½œçš„ç‡’è‡˜ï¼Œçš®è„†è‚‰å«©",
                rating: 4.6,
                category: "rice",
                price: "NT$ 110-150",
                hours: "10:30-20:30",
                address: "å°åŒ—å¸‚ä¸­æ­£å€é–‹å°è¡—ä¸€æ®µ18è™Ÿ",
                phone: "02-2314-6677",
                features: ["æ¯æ—¥ç¾çƒ¤", "å¤–å¸¶ä¾¿ç•¶", "æ¸¯å¼é£²å“"]
            },
            {
                name: "ç¾©å¤§åˆ©éºµé¤¨",
                lat: 25.0440,
                lng: 121.5140,
                description: "æ‰‹å·¥è£½ä½œçš„ç¾©å¤§åˆ©éºµï¼Œé†¬æ±æ¿ƒéƒ",
                rating: 4.3,
                category: "western",
                price: "NT$ 180-280",
                hours: "11:30-21:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€æ­¦æ˜Œè¡—ä¸€æ®µ22è™Ÿ",
                phone: "02-2388-9900",
                features: ["æ‰‹å·¥éºµæ¢", "èµ·å¸ç¾åˆ¨", "ç´…é…’æ­é…"]
            },
            {
                name: "éŸ“å¼æ–™ç†",
                lat: 25.0510,
                lng: 121.5130,
                description: "æ­£å®—éŸ“åœ‹çƒ¤è‚‰èˆ‡å‚³çµ±æ–™ç†",
                rating: 4.5,
                category: "rice",
                price: "NT$ 250-400",
                hours: "11:00-22:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€ä¸­è¯è·¯ä¸€æ®µ25è™Ÿ",
                phone: "02-2315-7788",
                features: ["å°èœç„¡é™", "å°ˆäººç‡’çƒ¤", "éŸ“å¼é…’é¡"]
            },
            {
                name: "å°å¼æ»·è‚‰é£¯",
                lat: 25.0430,
                lng: 121.5190,
                description: "å‚³çµ±å°ç£å°åƒï¼Œæ»·æ±é¦™æ¿ƒ",
                rating: 4.1,
                category: "rice",
                price: "NT$ 40-80",
                hours: "06:00-20:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€é‡æ…¶å—è·¯ä¸€æ®µ12è™Ÿ",
                phone: "02-2382-3344",
                features: ["24å¹´è€åº—", "å¿«é€Ÿå‡ºé¤", "éŠ…æ¿ç¾é£Ÿ"]
            },
            {
                name: "å¥åº·æ²™æ‹‰å§",
                lat: 25.0520,
                lng: 121.5150,
                description: "è‡ªé¸æ²™æ‹‰å§ï¼Œæ–°é®®é£Ÿæä»»ä½ æ­é…",
                rating: 4.2,
                category: "light",
                price: "NT$ 120-180",
                hours: "10:00-19:00",
                address: "å°åŒ—å¸‚ä¸­æ­£å€ä¿¡é™½è¡—6è™Ÿ",
                phone: "02-2316-8899",
                features: ["è‡ªé¸é…æ–™", "ä½å¡é†¬æ±", "å¤–å¸¶é¤ç›’"]
            }
        ];
        
        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingMessage = document.getElementById('loadingMessage');
            const navbar = document.getElementById('navbar');
            const locateBtn = document.getElementById('locateBtn');
            const filterContainer = document.getElementById('filterContainer');
            const statusText = document.getElementById('status-text');
            
            // è¼‰å…¥ç‹€æ…‹è®Šæ•¸
            let leafletLoaded = false;
            let mapInitialized = false;
            let restaurantMarkers = [];
            let userMarker = null;
            
            // æ›´æ–°è¼‰å…¥è¨Šæ¯
            loadingMessage.textContent = 'è¼‰å…¥åœ°åœ–è³‡æº...';
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            statusText.textContent = `è¼‰å…¥ ${restaurants.length} é–“é¤å»³`;
            
            // 1. å‹•æ…‹è¼‰å…¥ Leaflet JS
            loadLeaflet();
            
            // è¼‰å…¥ Leaflet å‡½æ•¸
            function loadLeaflet() {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥
                if (window.L) {
                    leafletLoaded = true;
                    initializeMap();
                    return;
                }
                
                // å‹•æ…‹è¼‰å…¥ Leaflet JS
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js';
                
                script.onload = function() {
                    leafletLoaded = true;
                    loadingMessage.textContent = 'åˆå§‹åŒ–åœ°åœ–...';
                    setTimeout(initializeMap, 100);
                };
                
                script.onerror = function() {
                    loadingMessage.textContent = 'è¼‰å…¥åœ°åœ–å¤±æ•—ï¼Œå˜—è©¦æ›¿ä»£æ–¹æ¡ˆ...';
                    loadLeafletFallback();
                };
                
                document.head.appendChild(script);
            }
            
            // å‚™ç”¨CDNè¼‰å…¥
            function loadLeafletFallback() {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                
                fallbackScript.onload = function() {
                    leafletLoaded = true;
                    loadingMessage.textContent = 'åˆå§‹åŒ–åœ°åœ–...';
                    setTimeout(initializeMap, 100);
                };
                
                document.head.appendChild(fallbackScript);
            }
            
            // åˆå§‹åŒ–åœ°åœ–
            function initializeMap() {
                if (mapInitialized) return;
                
                try {
                    // å‰µå»ºåœ°åœ–å¯¦ä¾‹
                    window.map = L.map('map').setView([25.0478, 121.5170], 15);
                    
                    // è¼‰å…¥åœ°åœ–åœ–å±¤
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                        tileSize: 256,
                        zoomOffset: 0
                    }).addTo(window.map);
                    
                    mapInitialized = true;
                    
                    // è¼‰å…¥å®Œæˆå¾Œçš„æ“ä½œ
                    setTimeout(function() {
                        // éš±è—åŠ è¼‰ç•«é¢
                        loadingScreen.classList.add('hidden');
                        
                        // é¡¯ç¤ºå°è¦½åˆ—ã€éæ¿¾å™¨å’Œå®šä½æŒ‰éˆ•
                        navbar.classList.add('visible');
                        locateBtn.classList.add('visible');
                        filterContainer.classList.add('visible');
                        
                        // æ›´æ–°ç‹€æ…‹æ–‡å­—
                        statusText.textContent = `${restaurants.length} é–“é¤å»³`;
                        
                        // åˆå§‹åŒ–é¤å»³æ¨™è¨˜
                        initializeRestaurants();
                        
                        // åˆå§‹åŒ–éæ¿¾å™¨äº‹ä»¶
                        initializeFilters();
                        
                        // è‡ªå‹•å®šä½ï¼ˆå¯é¸ï¼‰
                        // setTimeout(locateUser, 1000);
                    }, 300);
                    
                } catch (error) {
                    console.error('åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:', error);
                    loadingMessage.textContent = 'åœ°åœ–åˆå§‹åŒ–å¤±æ•—';
                    
                    // é¡¯ç¤ºéŒ¯èª¤ä½†ç¹¼çºŒ
                    setTimeout(function() {
                        loadingScreen.classList.add('hidden');
                        navbar.classList.add('visible');
                        alert('åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œä½†æ‚¨å¯ä»¥ç¹¼çºŒä½¿ç”¨å…¶ä»–åŠŸèƒ½');
                    }, 1500);
                }
            }
            
            // åˆå§‹åŒ–é¤å»³æ¨™è¨˜
            function initializeRestaurants() {
                if (!window.map || !window.L) return;
                
                // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
                restaurantMarkers.forEach(marker => {
                    window.map.removeLayer(marker);
                });
                restaurantMarkers = [];
                
                // è‡ªè¨‚åœ–ç¤º (é¤å»³æ¨™è¨˜)
                const createRestaurantIcon = (category) => {
                    return L.divIcon({
                        className: `restaurant-marker ${category}`,
                        iconSize: [36, 36],
                        iconAnchor: [18, 18],
                        popupAnchor: [0, -18]
                    });
                };
                
                // å°‡é¤å»³æ¨™è¨˜åˆ°åœ°åœ–ä¸Š
                restaurants.forEach(restaurant => {
                    const icon = createRestaurantIcon(restaurant.category);
                    
                    const marker = L.marker([restaurant.lat, restaurant.lng], {icon: icon})
                     .bindPopup(createRestaurantPopup(restaurant))
                     .addTo(window.map);
                    
                    // ä¿å­˜æ¨™è¨˜åƒè€ƒ
                    restaurant.marker = marker;
                    restaurantMarkers.push(marker);
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    marker.on('click', function() {
                        // é«˜äº®é¡¯ç¤ºé»æ“Šçš„æ¨™è¨˜
                        highlightMarker(marker);
                    });
                });
                
                console.log(`å·²åˆå§‹åŒ– ${restaurantMarkers.length} å€‹é¤å»³æ¨™è¨˜`);
            }
            
            // å‰µå»ºé¤å»³å½ˆå‡ºè¦–çª—å…§å®¹
            function createRestaurantPopup(restaurant) {
                const stars = 'â˜…'.repeat(Math.floor(restaurant.rating)) + 'â˜†'.repeat(5 - Math.floor(restaurant.rating));
                
                return `
                    <div class="restaurant-popup">
                        <div class="restaurant-header">
                            <h3 class="restaurant-name">${restaurant.name}</h3>
                        </div>
                        
                        <div class="restaurant-rating">
                            <div class="rating-stars">${stars}</div>
                            <div class="rating-value">${restaurant.rating}</div>
                        </div>
                        
                        <p class="restaurant-description">${restaurant.description}</p>
                        
                        <div class="restaurant-details">
                            <div class="detail-item">
                                <span class="material-symbols-rounded" style="font-size: 1rem;">payments</span>
                                <span class="detail-label">åƒ¹æ ¼</span>
                                <span>${restaurant.price}</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-symbols-rounded" style="font-size: 1rem;">schedule</span>
                                <span class="detail-label">ç‡Ÿæ¥­</span>
                                <span>${restaurant.hours}</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-symbols-rounded" style="font-size: 1rem;">location_on</span>
                                <span class="detail-label">åœ°å€</span>
                                <span>${restaurant.address}</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-symbols-rounded" style="font-size: 1rem;">call</span>
                                <span class="detail-label">é›»è©±</span>
                                <span>${restaurant.phone}</span>
                            </div>
                        </div>
                        
                        <div class="restaurant-actions">
                            <button class="action-btn" onclick="navigateToRestaurant('${restaurant.lat}', '${restaurant.lng}')">
                                <span class="material-symbols-rounded" style="font-size: 1rem; vertical-align: middle;">directions</span>
                                å°èˆª
                            </button>
                            <button class="action-btn" onclick="saveRestaurant('${restaurant.name}')">
                                <span class="material-symbols-rounded" style="font-size: 1rem; vertical-align: middle;">bookmark</span>
                                æ”¶è—
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // é«˜äº®é¡¯ç¤ºæ¨™è¨˜
            function highlightMarker(marker) {
                // ç§»é™¤æ‰€æœ‰æ¨™è¨˜çš„é«˜äº®
                restaurantMarkers.forEach(m => {
                    const icon = m.options.icon;
                    if (icon.options.className.includes('highlighted')) {
                        icon.options.className = icon.options.className.replace(' highlighted', '');
                        m.setIcon(icon);
                    }
                });
                
                // é«˜äº®ç•¶å‰æ¨™è¨˜
                const icon = marker.options.icon;
                if (!icon.options.className.includes('highlighted')) {
                    icon.options.className += ' highlighted';
                    marker.setIcon(icon);
                    
                    // 5ç§’å¾Œç§»é™¤é«˜äº®
                    setTimeout(() => {
                        icon.options.className = icon.options.className.replace(' highlighted', '');
                        marker.setIcon(icon);
                    }, 5000);
                }
            }
            
            // åˆå§‹åŒ–éæ¿¾å™¨äº‹ä»¶
            function initializeFilters() {
                const filterInputs = document.querySelectorAll('.filter-checkbox input');
                
                filterInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        filterRestaurants();
                    });
                });
            }
            
            // éæ¿¾é¤å»³
            function filterRestaurants() {
                const showNoodle = document.getElementById('filter-noodle').checked;
                const showRice = document.getElementById('filter-rice').checked;
                const showWestern = document.getElementById('filter-western').checked;
                const showLight = document.getElementById('filter-light').checked;
                const showRating4 = document.getElementById('filter-rating-4').checked;
                
                let visibleCount = 0;
                
                restaurants.forEach((restaurant, index) => {
                    const marker = restaurant.marker;
                    let shouldShow = false;
                    
                    // æª¢æŸ¥é¡å‹
                    if ((restaurant.category === 'noodle' && showNoodle) ||
                        (restaurant.category === 'rice' && showRice) ||
                        (restaurant.category === 'western' && showWestern) ||
                        (restaurant.category === 'light' && showLight)) {
                        shouldShow = true;
                    }
                    
                    // æª¢æŸ¥è©•åˆ†
                    if (showRating4 && restaurant.rating < 4) {
                        shouldShow = false;
                    }
                    
                    // é¡¯ç¤ºæˆ–éš±è—æ¨™è¨˜
                    if (shouldShow) {
                        if (!window.map.hasLayer(marker)) {
                            marker.addTo(window.map);
                        }
                        visibleCount++;
                    } else {
                        if (window.map.hasLayer(marker)) {
                            window.map.removeLayer(marker);
                        }
                    }
                });
                
                // æ›´æ–°ç‹€æ…‹æ–‡å­—
                statusText.textContent = `${visibleCount} é–“é¤å»³`;
            }
            
            // å®šä½ç”¨æˆ¶å‡½æ•¸
            window.locateUser = function() {
                if (!navigator.geolocation) {
                    alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½");
                    statusText.textContent = "ä¸æ”¯æ´å®šä½";
                    return;
                }
                
                statusText.textContent = "å®šä½ä¸­...";
                
                // è¨­å®šå®šä½è¶…æ™‚
                const timeoutId = setTimeout(function() {
                    statusText.textContent = "å®šä½è¶…æ™‚";
                    alert("å®šä½è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦");
                }, 10000);
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(timeoutId);
                        
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // æ›´æ–°ç‹€æ…‹æ–‡å­—
                        statusText.textContent = "å®šä½å®Œæˆ";
                        
                        // å¦‚æœå·²ç¶“æœ‰ç”¨æˆ¶æ¨™è¨˜ï¼Œå°±ç§»é™¤èˆŠçš„
                        if (userMarker) {
                            window.map.removeLayer(userMarker);
                        }
                        
                        // è‡ªè¨‚åœ–ç¤º (ç”¨æˆ¶ä½ç½®æ¨™è¨˜)
                        const userIcon = L.divIcon({
                            className: 'user-marker',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12],
                            popupAnchor: [0, -12]
                        });
                        
                        // æ–°å¢ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
                        userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(window.map)
                            .bindPopup(`
                                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 10px;">
                                    <h3 style="margin: 0 0 5px 0; font-weight: 400; font-size: 1.1rem;">æ‚¨çš„ä½ç½®</h3>
                                    <p style="margin: 0; font-size: 0.85rem; color: #9e9e9e;">ç·¯åº¦: ${lat.toFixed(6)}<br>ç¶“åº¦: ${lng.toFixed(6)}</p>
                                </div>
                            `).openPopup();
                        
                        // ç§»å‹•è¦–è§’åˆ°ç”¨æˆ¶ä½ç½®
                        window.map.flyTo([lat, lng], 16);
                        
                        // 5ç§’å¾Œæ¢å¾©ç‹€æ…‹æ–‡å­—
                        setTimeout(function() {
                            statusText.textContent = `${restaurants.length} é–“é¤å»³`;
                        }, 5000);
                    },
                    (error) => {
                        clearTimeout(timeoutId);
                        
                        console.error(error);
                        statusText.textContent = "å®šä½å¤±æ•—";
                        
                        let errorMessage = "ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "ä½ç½®æ¬Šé™è¢«æ‹’çµ•";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "ä½ç½®è³‡è¨Šä¸å¯ç”¨";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "å®šä½è«‹æ±‚è¶…æ™‚";
                                break;
                            default:
                                errorMessage = "æœªçŸ¥çš„å®šä½éŒ¯èª¤";
                                break;
                        }
                        
                        alert(errorMessage + "ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±æ¬Šé™ã€‚");
                        
                        // 5ç§’å¾Œæ¢å¾©ç‹€æ…‹æ–‡å­—
                        setTimeout(function() {
                            statusText.textContent = `${restaurants.length} é–“é¤å»³`;
                        }, 5000);
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 8000, // 8ç§’è¶…æ™‚
                        maximumAge: 0
                    }
                );
            };
            
            // å°èˆªåˆ°é¤å»³
            window.navigateToRestaurant = function(lat, lng) {
                // é€™è£¡å¯ä»¥å¯¦ç¾å°èˆªåŠŸèƒ½
                alert(`å°èˆªåˆ°é¤å»³ä½ç½®\nç·¯åº¦: ${lat}\nç¶“åº¦: ${lng}`);
            };
            
            // æ”¶è—é¤å»³
            window.saveRestaurant = function(restaurantName) {
                // é€™è£¡å¯ä»¥å¯¦ç¾æ”¶è—åŠŸèƒ½
                alert(`å·²æ”¶è—é¤å»³: ${restaurantName}`);
            };
            
            // å¦‚æœLeafletè¼‰å…¥è¶…æ™‚ï¼Œé¡¯ç¤ºéŒ¯èª¤
            setTimeout(function() {
                if (!leafletLoaded) {
                    loadingMessage.textContent = 'è¼‰å…¥æ™‚é–“éé•·ï¼Œå˜—è©¦æ›¿ä»£æ–¹æ¡ˆ...';
                    loadLeafletFallback();
                }
            }, 5000);
            
            // å¦‚æœåœ°åœ–åˆå§‹åŒ–è¶…æ™‚
            setTimeout(function() {
                if (!mapInitialized && leafletLoaded) {
                    loadingMessage.textContent = 'æ­£åœ¨å˜—è©¦åˆå§‹åŒ–åœ°åœ–...';
                    try {
                        initializeMap();
                    } catch (e) {
                        console.error('åœ°åœ–åˆå§‹åŒ–é‡è©¦å¤±æ•—:', e);
                        loadingMessage.textContent = 'åœ°åœ–åˆå§‹åŒ–å¤±æ•—';
                        loadingScreen.classList.add('hidden');
                        navbar.classList.add('visible');
                    }
                }
            }, 8000);
        });
    </script>
</body>
</html>